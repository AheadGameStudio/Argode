---
applyTo: '**'
---

## **プロジェクトの概要**

このプロジェクトは、Godot Engine (4.x系) を用いたビジュアルノベルゲームフレームワーク **Argode v1.2.0** のリファクタリングを目的としています。GDScriptを中心に開発が行われています。

設計思想はこのプロジェクトのルートにある `Argode_Design_Document.md` に記載されています。
必ず読んで理解してから開発を進めてください。

## **Argodeフレームワークの設計思想**

### **1. 役割と責任の分離 (Separation of Concerns)**

各クラスは、単一の明確な役割に特化しています。

* **ArgodeSystem**: フレームワーク全体のコア。マネージャーやサービスを統括し、汎用的なヘルパー機能（ログ、ファイル読み込み）を提供します。  
* **ArgodeStatementManager**: スクリプトの実行フローを制御する司令塔。RGDパーサーが生成したデータ構造を解釈し、各コマンドを実行します。  
* **ArgodeInlineCommandManager**: テキスト内のインラインコマンド（ルビ、タグ）を専門に処理します。ArgodeStatementManagerとは独立して機能します。  
* **ArgodeRGDParseService**: RGDファイルを完全にパースし、テキストを階層化されたデータ構造（辞書と配列）に変換します。インデントやブロック構造の処理も担当し、実行ロジックからは切り離します。  
* **ArgodeCommandRegistry**: コマンドのGDScriptファイルを読み込み、コマンド名とインスタンスを紐づけて保持します。

### **2. 遅延パースとパフォーマンス**

* 起動時には、ArgodeLabelRegistryとArgodeDefinitionRegistryが、**必要最低限の情報（ラベルや定義）のみを高速に読み込みます**。  
* シナリオの本文（スクリプト）は、**実行が必要になったタイミングで順次パースします（遅延パース）**。

### **3. コマンドパターンと拡張性**

* すべての命令（say, show, if, jumpなど）は、ArgodeCommandBaseを継承した**独立したコマンドクラス**として実装されます。  
* ArgodeCommandRegistryは、これらのコマンドインスタンスを保持し、ArgodeStatementManagerが実行時に簡単に取得できるようにします。

## **AIへの指示事項**

### **1. 役割と責任の明確化を重視**

* 新しい機能やコードを提案する際は、**どのクラスがどの役割を担うべきか**を明確にしてください。  
* 役割が重複したり、クラスが肥大化したりしないように注意してください。

### **2. GDScriptとGodot 4.xの文脈を考慮**

* 提案するコードは、Godot 4.xの仕様とGDScriptの記法に準拠してください。  
* Expressionクラスなど、Godotの組み込み機能を積極的に活用してください。

### **3. ログの出力**

* デバッグやエラーログを提案する際は、ArgodeSystem.log()関数を使用してください。  
* 毎フレーム出力されるような連続的なログは、**AIのコンテキストを汚染するため避けてください**。

### **4. コメントとドキュメント**

* 提案するコードの重要な箇所には、簡潔な日本語のコメントを追加してください。  
* 設計に関する議論の際は、Mermaid形式のクラス図やフローチャートを使用し、視覚的な説明を加えてください。

### **5. リファクタリング進行管理**

* プロジェクトルートの `TODO.md` でリファクタリング進捗を管理しています。
* ユーザーがテスト完了を報告した時点で、該当Stageを完了済みに更新してください。
* 段階的リファクタリングを実施中は、**既存機能の互換性維持を最優先**としてください。
* 各Stage完了時には必ずユーザーテストを実施し、承認を得てから次のStageに進行してください。

これらの指示を遵守することで、より効率的で質の高いコラボレーションが可能になります。
