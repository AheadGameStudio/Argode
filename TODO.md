# TODO List - Ren' Gd ADVアドオン

このファイルは、設計書v1/v2の比較分析に基づいた更新版タスクリストです。

## 🏗️ アーキテクチャ移行 (v1 → v2設計)

**現状:** v1設計に基づく実装（複数オートロード、リソース中心）
**目標:** v2設計への移行（単一オートロード、スクリプト中心定義）

### 📊 設計変更の影響度評価
- [x] v1とv2の設計差分分析完了
- [x] **CRITICAL:** 単一オートロード(AdvSystem)への統合設計
- [x] **HIGH:** スクリプト中心定義システムの実装
- [ ] **MEDIUM:** カスタムコマンド/タグ拡張フレームワーク
- [ ] **LOW:** 予測プリロード・動的アンロードシステム

## 📋 コア機能の実装

### 🎯 スクリプト実行エンジン (v1実装完了 / v2対応必要)
- [x] `AdvScriptPlayer.gd` の実装 *(v1仕様)*
  - [x] 正規表現パターンの定義
  - [x] `load_script()` メソッド実装
  - [x] `_preparse_labels()` メソッド実装
  - [x] `_parse_and_execute()` メソッド実装
  - [x] コマンド解析・実行ロジック（基本部分）
  - [x] コールスタック管理（基本部分）
- [x] **v2移行:** AdvSystem統合対応
- [ ] **v2新機能:** カスタムコマンドシグナル発行システム
- [ ] **v2新機能:** インラインタグ解析エンジン

### 👤 キャラクター管理システム (v1実装完了 / v2対応必要)
- [x] `CharacterData.gd` リソースクラス実装 *(v1仕様)*
  - [x] `display_name` プロパティ
  - [x] `name_color` プロパティ
  - [x] 画像パス管理（プレースホルダー対応）
- [x] `CharacterManager.gd` 実装 *(v1仕様)*
  - [x] `show_character()` メソッド
  - [x] キャラクター画像の表示・更新
  - [x] スプライト管理
  - [x] トランジション連携
- [x] **v2移行:** CharacterDefinitionManager実装
- [x] **v2新機能:** `character` ステートメント解析
- [ ] **v2新機能:** コールバック機能（show_callback, hide_callback等）

### 🎨 UI管理システム (v1実装完了 / v2大幅拡張必要)
- [x] `UIManager.gd` 実装（基本部分） *(v1仕様)*
  - [x] `show_message()` メソッド
  - [x] `show_choices()` メソッド（完全版）
  - [x] テキストボックス表示
  - [x] 選択肢UI生成・制御
  - [x] ボタンイベント処理
- [x] `BaseAdvGameUI.gd` 基本UIクラス *(v1仕様)*
- [ ] **v2移行:** AdvScreen基底クラス実装 *(v2の重要機能)*
- [ ] **v2新機能:** スクリーンスタック管理
- [ ] **v2新機能:** `call_screen` コマンド対応

### 🎬 演出・トランジション管理 (v1実装完了)
- [x] `TransitionPlayer.gd` 実装 *(v1仕様)*
  - [x] `play()` メソッド
  - [x] fade, dissolve などの基本トランジション実装
  - [x] Tweenアニメーション制御
  - [x] シグナル管理
- [ ] **v2対応:** レイヤーベース演出システム

### 🧮 変数管理システム (v1実装完了)
- [x] `VariableManager.gd` 実装 *(v1仕様)*
  - [x] `set_variable()` メソッド
  - [x] `evaluate_condition()` メソッド
  - [x] `set_character_def()` メソッド
  - [x] Expression評価機能
  - [x] 変数展開機能（`expand_variables()`）

## 📝 スクリプトコマンド対応

### 基本コマンド (v1実装完了)
- [x] `say` コマンド（セリフ表示） *(v1仕様)*
- [x] `set` コマンド（変数操作） *(v1仕様)*
- [x] `if/else` コマンド（条件分岐） *(v1仕様)*
- [x] `menu` コマンド（選択肢） *(v1仕様)*
- [x] `jump` コマンド（ラベルジャンプ） *(v1仕様)*
- [x] `call/return` コマンド（サブルーチン） *(v1仕様)*

### 演出コマンド (v1実装完了)
- [x] `scene` コマンド（背景表示） *(v1仕様)*
- [x] `show` コマンド（キャラクター表示） *(v1仕様)*
- [x] `hide` コマンド（キャラクター非表示） *(v1仕様)*
- [x] `with` 句（トランジション指定） *(v1仕様)*

### 高度な機能 (v1実装完了)
- [x] `define` コマンド（キャラクター定義） *(v1仕様)*
- [x] `label` の前処理・解析 *(v1仕様)*
- [x] 変数展開（`{variable_name}` + v2 `[variable_name]`） *(v1+v2対応)*
- [x] コメント行の処理 *(v1仕様)*

### v2新機能
- [x] **CRITICAL:** 定義ステートメント (`character`, `image`, `audio`, `shader`) - 事前解析システム完了
- [x] **HIGH:** カスタムコマンドシグナル発行 (例: `window`, `camera_shake`) - ✅ 14種類完全実装
- [x] **HIGH:** カスタムインラインタグ解析 (例: `{shake}`, `{w=0.5}`) - ✅ InlineTagProcessor完全実装
- [ ] **MEDIUM:** `call_screen` コマンド実装
- [x] **MEDIUM:** 変数展開と インラインタグの構文分離 (`[var]` vs `{tag}`)

## 🔧 プロジェクト構成

### ディレクトリ構造 (v1完了)
- [x] `addons/adv_engine/` フォルダ作成
- [x] `managers/` サブフォルダ作成
- [x] `characters/` フォルダ作成
- [x] `scenarios/` フォルダ作成
- [x] `images/` フォルダ作成
- [x] `ui/` フォルダ作成 (BaseAdvGameUI)

### プラグイン設定 (v1完了 / v2要修正)
- [x] `plugin.cfg` 作成
- [x] プラグインクラス実装
- [x] オートロード設定（推奨設定の文書化） *(v1: 6個のシングルトン)*
- [x] **v2移行:** 単一オートロード(AdvSystem)への変更
- [x] **v2移行:** プラグイン有効化時の自動設定

## 🧪 テスト・サンプル

### サンプルファイル
- [x] `sample.rgd` シナリオファイル作成
- [x] `yuko.tres` キャラクターリソース作成
- [x] `saitos.tres` キャラクターリソース作成
- [x] `transition_test.rgd` トランジションテスト用シナリオ作成
- [ ] テスト用画像素材準備

### デモシーン
- [x] `MainScene.tscn` 作成（既存）
- [x] `MainScene.gd` スクリプト実装
- [x] 入力処理の実装（基本）

### サンプルUI
- [x] `design/gui/` フォルダ作成
- [x] サンプルUIシーン作成 (`AdvGameUI.tscn`)
- [x] テキストボックスUI（RichTextLabel対応）
- [x] 選択肢ボタンUI（動的生成）
- [x] UIManagerとの連携実装
- [x] 使用方法サンプルシーン (`usage_sample.tscn`)
- [x] ドキュメント作成 (`README.md`)
- [x] タイプライター風テキスト表示機能 (`TypewriterText.gd`)

## 📚 ドキュメント・マニュアル

### 開発者向け
- [ ] API リファレンス
- [ ] アーキテクチャ解説
- [ ] 拡張・カスタマイズガイド

### 利用者向け
- [ ] クイックスタートガイド
- [ ] スクリプトコマンドリファレンス
- [ ] チュートリアル

## 🚀 v2設計 新機能実装

### 🏗️ 統合アーキテクチャ (CRITICAL) - ✅ 完了
- [x] `AdvSystem.gd` 実装（単一オートロード）
- [x] 既存Manager統合（子ノード化）
- [x] レイヤーマッピング機能
- [x] 統一初期化システム (`initialize_game()`)

### 📊 定義管理システム (HIGH) - ✅ 基本実装完了
- [x] `ImageDefinitionManager.gd` - `image` ステートメント解析
- [x] `CharacterDefinitionManager.gd` - `character` ステートメント解析
- [x] `AudioDefinitionManager.gd` - `audio` ステートメント解析
- [x] `ShaderDefinitionManager.gd` - `shader` ステートメント解析

### 🎭 拡張フレームワーク (HIGH) - ✅ 完了
- [x] カスタムコマンドシグナル発行機能
- [x] カスタムインラインタグ解析機能
- [x] 拡張コマンド登録API

### 🖥️ AdvScreenシステム (MEDIUM) - ✅ 基本実装完了
- [x] `AdvScreen.gd` 基底クラス実装
- [x] UIから直接シナリオ操作API
- [x] AdvGameUI統合（main_demo.rgdで動作確認済み）
- [ ] スクリーンスタック管理（将来実装予定）
- [ ] `call_screen` / `close_screen` 機能（将来実装予定）

### 🧠 予測プリロード (LOW)
- [ ] 制御フローグラフ構築
- [ ] アセット依存関係解析
- [ ] 動的プリロード・アンロード機能

## 🚀 Ren'Py機能との比較・不足機能

### 📋 セーブ・ロードシステム
- [ ] ゲーム状態のセーブ機能（変数、位置、フラグ等）
- [ ] ロード機能（セーブデータからの復帰）
- [ ] セーブスロット管理
- [ ] オートセーブ機能
- [ ] クイックセーブ・ロード（F5/F9等）

### 🎵 オーディオシステム
- [ ] BGM再生・管理（`play music`コマンド）
- [ ] SE再生（`play sound`コマンド）
- [ ] 音声ファイル（`play voice`コマンド）
- [ ] オーディオチャンネル管理
- [ ] フェードイン・アウト対応
- [ ] 音量設定・ミュート機能

### 📜 履歴・ログシステム  
- [ ] バックログ機能（既読テキスト履歴）
- [ ] 履歴画面UI
- [ ] 履歴から任意位置に戻る機能
- [ ] テキスト表示履歴の保存

### ⏩ 自動進行・スキップ機能
- [ ] オート機能（自動メッセージ進行）
- [ ] スキップ機能（高速進行・既読スキップ）
- [ ] 進行速度設定
- [ ] スキップモード切り替えUI

### 🔧 設定・環境システム
- [ ] 環境設定画面（音量、速度等）
- [ ] ゲーム設定の永続化
- [ ] フルスクリーン切り替え
- [ ] ウィンドウサイズ管理

### 🏷️ 高度なラベル・制御機能
- [ ] `call`文の完全実装（戻り値対応）
- [ ] `return`文の引数対応
- [ ] ネストした`call`スタック管理
- [ ] `jump_out_of_context`相当機能

### 🎨 高度な演出機能
- [ ] `at transform`（アニメーション変形）
- [ ] `show expression`（動的画像指定）
- [ ] レイヤー管理（master, overlay等）
- [ ] 画面効果（`with Fade()`等カスタムトランジション）

### 🐍 Python統合機能
- [ ] `$`文（Python式の実行）
- [ ] `python:`ブロック（複数行Python）
- [ ] `default`文（変数初期値設定）
- [ ] `init python:`（初期化時Python実行）

### 🌐 国際化・多言語対応
- [ ] 翻訳システム（`__()`関数）
- [ ] 言語切り替え機能
- [ ] フォント管理（言語別フォント）
- [ ] テキスト方向対応（LTR/RTL）

### 🛠️ デバッグ・開発支援
- [ ] 開発者コンソール（Shift+O相当）
- [ ] 変数ウォッチ機能
- [ ] リアルタイムスクリプト更新
- [ ] Lintツール（スクリプト検証）
- [ ] エラー箇所の詳細表示

### 🎮 入力・操作拡張
- [ ] キーボードショートカット設定
- [ ] マウスホイール対応
- [ ] ジョイパッド対応
- [ ] タッチデバイス対応

### 📊 統計・解析機能
- [ ] プレイ時間記録
- [ ] 選択肢統計
- [ ] 達成率管理
- [ ] エンディング到達記録

## 🚀 追加検討事項

### 機能拡張（既存項目）
- [ ] セーブ・ロード機能 → 上記詳細項目に統合
- [ ] バックログ機能 → 上記詳細項目に統合  
- [ ] スキップ・オート機能 → 上記詳細項目に統合
- [ ] BGM・SE管理 → 上記詳細項目に統合
- [ ] 多言語対応 → 上記詳細項目に統合

### UI・UX拡張
- [x] タイプライター風テキスト表示
- [ ] タイプライター効果音システム
- [ ] テキスト表示速度設定UI
- [ ] メッセージウィンドウアニメーション

### 最適化・改良
- [ ] パフォーマンス最適化
- [ ] エラーハンドリング強化
- [ ] デバッグ機能 → 上記詳細項目に統合
- [ ] エディタ統合機能

---

## 🎯 v2移行ロードマップ

### Phase 1: 緊急対応 (CRITICAL) - ✅ 完了
1. **AdvSystem統合**: 現在の6個のオートロードを1個に統合 - 完了
2. **定義ステートメント実装**: `character`, `image`等の新構文対応 - 完了

### Phase 2: 高優先機能 (HIGH) 
3. **拡張フレームワーク**: カスタムコマンド・タグシステム
4. **AdvScreen実装**: v2の新UI基盤

### Phase 3: 完全移行 (MEDIUM-LOW)
5. **予測プリロード**: メモリ効率化
6. **レイヤーベース演出**: 高度な画面制御

**注意:** v2移行により既存v1コードに**破壊的変更**が発生する可能性があります

---

## ✅ v2移行完了報告（2025-01-13）

## 🎉 Phase 2完了報告（2025-01-18）

### ✅ **カスタムコマンド拡張フレームワーク完全実装**
- **14種類のカスタムコマンド**: window, camera_shake, screen_flash, text_animate, ui_slide, ui_fade, particles, zoom, tint, blur, wait, vibrate, sound_effect, custom_transition
- **混合パラメータ解析**: 位置パラメータ + key=value形式の柔軟な構文解析
- **同期処理システム**: waitコマンドの非同期処理対応
- **視覚効果統合**: AdvGameUIでの完全な視覚効果実装
- **包括的ドキュメント**: CUSTOM_COMMANDS.mdによる詳細リファレンス

### ✅ **プロジェクト構造最適化**
- **テストファイル整理**: scenarios/tests/への14個のテストファイル移動
- **パフォーマンス向上**: ラベルスキャン時間 20→5 labels（80%短縮）
- **ドキュメント統合**: v2対応の包括的ドキュメント更新
- **不要ファイル削除**: v1バックアップファイルとテストファイル削除

### 🎉 Phase 1 完了項目
- **AdvSystem統合アーキテクチャ**: 6個のオートロードを1個に統合完了
- **スクリプト中心定義システム**: character, image, audio, shader定義ステートメント実装完了
- **v2コア機能動作確認**: v2_test.rgdで動作テスト成功
- **v1/v2重複コードクリーンアップ**: フォールバック処理を削除し、v2単一アーキテクチャに統一

### 🔧 修正した主な問題
1. **定義ステートメント処理**: スクリプトロード時の事前解析システム実装
2. **変数展開システム**: v2の`[variable]`形式に対応（v1の`{variable}`も継続サポート）
3. **シーン名解析**: スペースを含むシーン名（例: `bg school`）をサポート
4. **キャラクター表示**: v2定義システムとの連携を確立

### 🚀 次のフェーズ候補
- **Phase 2**: カスタムコマンド・タグ拡張フレームワーク
- **ImageDefinitionManager詳細実装**: アニメーション画像定義の完全サポート
- **AdvScreen基盤**: UIからの直接シナリオ操作API
- **コールバック機能**: show_callback, hide_callback等の実装