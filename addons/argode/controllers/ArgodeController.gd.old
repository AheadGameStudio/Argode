# ArgodeController.gd (Service Layer Patternçµ±åˆç‰ˆ)
extends Node

class_name ArgodeController

## ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯å…¨ä½“ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å…¥åŠ›ã‚’ä¸€å…ƒç®¡ç†ã™ã‚‹
## ã“ã®ã‚¯ãƒ©ã‚¹ã¯ã€Godotã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šã§å®šç¾©ã•ã‚ŒãŸå…¥åŠ›ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ã„ã€
## å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä»–ã®ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚„ã‚µãƒ¼ãƒ“ã‚¹ã«ä¼é”ã™ã‚‹ã€‚
## Service Layer Pattern: InputHandlerService ã¨ã®å”èª¿ã«ã‚ˆã‚Šé«˜åº¦ãªå…¥åŠ›åˆ¶å¾¡ã‚’å®Ÿç¾

# å…¥åŠ›ãŒç¾åœ¨è¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹
var _is_input_enabled: bool = true

# Service Layer Pattern: InputHandlerServiceçµ±åˆ
var input_handler_service: ArgodeInputHandlerService = null

# å…¥åŠ›ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ãã«é€ä¿¡ã•ã‚Œã‚‹ã‚·ã‚°ãƒŠãƒ«ï¼ˆInputHandlerServiceé€£æºï¼‰
signal input_action_pressed(action_name)
# å…¥åŠ›ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒé›¢ã•ã‚ŒãŸã¨ãã«é€ä¿¡ã•ã‚Œã‚‹ã‚·ã‚°ãƒŠãƒ«
signal input_action_released(action_name)
# æœ‰åŠ¹ãªå…¥åŠ›ãŒå‡¦ç†ã•ã‚ŒãŸã¨ãã®ã‚·ã‚°ãƒŠãƒ«ï¼ˆServiceå±¤çµ±åˆï¼‰
signal input_received(action_name)

func _ready():
	_initialize_service_integration()
	setup_argode_default_bindings()
	ArgodeSystem.log_workflow("ArgodeController initialized with Service Layer integration")

## Serviceå±¤çµ±åˆã®åˆæœŸåŒ–
func _initialize_service_integration():
	# InputHandlerServiceã¨ã®é€£æºã‚’å¾Œã‹ã‚‰è¨­å®šï¼ˆå¾ªç’°å‚ç…§å›é¿ï¼‰
	# StatementManagerãŒåˆæœŸåŒ–ã•ã‚ŒãŸã¨ãã«è¨­å®šã•ã‚Œã‚‹
	pass

## InputHandlerServiceã¨ã®é€£æºã‚’è¨­å®šï¼ˆStatementManagerã‹ã‚‰å‘¼ã³å‡ºã—ï¼‰
func connect_input_handler_service(service: ArgodeInputHandlerService):
	input_handler_service = service
	if input_handler_service:
		# Serviceå±¤ã‹ã‚‰ã®æœ‰åŠ¹å…¥åŠ›ã‚·ã‚°ãƒŠãƒ«ã‚’ä¸­ç¶™
		if not input_handler_service.valid_input_received.is_connected(_on_valid_input_from_service):
			input_handler_service.valid_input_received.connect(_on_valid_input_from_service)
		ArgodeSystem.log_workflow("InputHandlerService connected to ArgodeController")

## Serviceå±¤ã‹ã‚‰ã®æœ‰åŠ¹å…¥åŠ›ã‚’å—ä¿¡
func _on_valid_input_from_service(action_name: String):
	# ä»–ã®ã‚·ã‚¹ãƒ†ãƒ ã«å…¥åŠ›ã‚’é€šçŸ¥
	input_received.emit(action_name)
	ArgodeSystem.log_debug_detail("Valid input processed: %s" % action_name)

# ãƒ•ãƒ¬ãƒ¼ãƒ ãŒå‡¦ç†ã•ã‚Œã‚‹ãŸã³ã«å…¥åŠ›ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹
func _process(delta):
	if not _is_input_enabled:
		return

	# å…¨ã¦ã®å…¥åŠ›ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
	for action in InputMap.get_actions():
		if Input.is_action_just_pressed(action):
			_on_action_just_pressed(action)
		if Input.is_action_just_released(action):
			_on_action_just_released(action)

func _on_action_just_pressed(action_name: String):
	# ç‰¹å®šã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ãã®å‡¦ç†
	# ä¾‹: "ui_accept"ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒæŠ¼ã•ã‚ŒãŸå ´åˆã€å¯¾è©±ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã«é€šçŸ¥
	# ArgodeSystem.get_manager("DialogueManager").process_input("accept")
	
	# input_action_pressedã‚·ã‚°ãƒŠãƒ«ã‚’é€ä¿¡ï¼ˆServiceå±¤ã§å‡¦ç†ã•ã‚Œã‚‹ï¼‰
	ArgodeSystem.log_debug_detail("Input action pressed: %s" % action_name)
	input_action_pressed.emit(action_name)

func _on_action_just_released(action_name: String):
	# ç‰¹å®šã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒé›¢ã•ã‚ŒãŸã¨ãã®å‡¦ç†
	
	# input_action_releasedã‚·ã‚°ãƒŠãƒ«ã‚’é€ä¿¡
	input_action_released.emit(action_name)

## å…¥åŠ›ã‚’æœ‰åŠ¹ã«ã™ã‚‹ï¼ˆServiceå±¤çµ±åˆï¼‰
func enable_input(reason: String = ""):
	_is_input_enabled = true
	if input_handler_service:
		input_handler_service.enable_input(reason)
	if reason != "":
		ArgodeSystem.log_workflow("Input enabled: %s" % reason)

## å…¥åŠ›ã‚’ç„¡åŠ¹ã«ã™ã‚‹ï¼ˆServiceå±¤çµ±åˆï¼‰
func disable_input(reason: String = ""):
	_is_input_enabled = false
	if input_handler_service:
		input_handler_service.disable_input(reason)
	if reason != "":
		ArgodeSystem.log_workflow("Input disabled: %s" % reason)

## === InputMapå‹•çš„ç®¡ç†æ©Ÿèƒ½ ===

## æ–°ã—ã„å…¥åŠ›ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
func add_input_action(action_name: String, deadzone: float = 0.5) -> bool:
    if InputMap.has_action(action_name):
        ArgodeSystem.log("âš ï¸ Input action '%s' already exists" % action_name)
        return false
    
    InputMap.add_action(action_name, deadzone)
    ArgodeSystem.log("âœ… Added input action: %s (deadzone: %.2f)" % [action_name, deadzone])
    return true

## å…¥åŠ›ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
func remove_input_action(action_name: String) -> bool:
    if not InputMap.has_action(action_name):
        ArgodeSystem.log("âš ï¸ Input action '%s' does not exist" % action_name)
        return false
    
    InputMap.erase_action(action_name)
    ArgodeSystem.log("ğŸ—‘ï¸ Removed input action: %s" % action_name)
    return true

## å…¥åŠ›ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒ‰ã‚’è¿½åŠ 
func add_key_to_action(action_name: String, keycode: Key, physical: bool = false) -> bool:
    if not InputMap.has_action(action_name):
        ArgodeSystem.log("âŒ Input action '%s' does not exist" % action_name)
        return false
    
    var event = InputEventKey.new()
    event.keycode = keycode
    event.physical_keycode = keycode if physical else KEY_NONE
    
    InputMap.action_add_event(action_name, event)
    ArgodeSystem.log("ğŸ® Added key %s to action '%s'" % [OS.get_keycode_string(keycode), action_name])
    return true

## å…¥åŠ›ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«ãƒã‚¦ã‚¹ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
func add_mouse_button_to_action(action_name: String, button: MouseButton) -> bool:
    if not InputMap.has_action(action_name):
        ArgodeSystem.log("âŒ Input action '%s' does not exist" % action_name)
        return false
    
    var event = InputEventMouseButton.new()
    event.button_index = button
    
    InputMap.action_add_event(action_name, event)
    ArgodeSystem.log("ğŸ–±ï¸ Added mouse button %d to action '%s'" % [button, action_name])
    return true

## å…¥åŠ›ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚¸ãƒ§ã‚¤ãƒ‘ãƒƒãƒ‰ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
func add_joypad_button_to_action(action_name: String, button: JoyButton, device: int = -1) -> bool:
    if not InputMap.has_action(action_name):
        ArgodeSystem.log("âŒ Input action '%s' does not exist" % action_name)
        return false
    
    var event = InputEventJoypadButton.new()
    event.button_index = button
    event.device = device
    
    InputMap.action_add_event(action_name, event)
    ArgodeSystem.log("ğŸ® Added joypad button %d to action '%s'" % [button, action_name])
    return true

## å…¥åŠ›ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚¸ãƒ§ã‚¤ãƒ‘ãƒƒãƒ‰è»¸ã‚’è¿½åŠ 
func add_joypad_axis_to_action(action_name: String, axis: JoyAxis, axis_value: float, device: int = -1) -> bool:
    if not InputMap.has_action(action_name):
        ArgodeSystem.log("âŒ Input action '%s' does not exist" % action_name)
        return false
    
    var event = InputEventJoypadMotion.new()
    event.axis = axis
    event.axis_value = axis_value
    event.device = device
    
    InputMap.action_add_event(action_name, event)
    ArgodeSystem.log("ğŸ•¹ï¸ Added joypad axis %d (value: %.2f) to action '%s'" % [axis, axis_value, action_name])
    return true

## å…¥åŠ›ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ç‰¹å®šã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤
func remove_event_from_action(action_name: String, event: InputEvent) -> bool:
    if not InputMap.has_action(action_name):
        ArgodeSystem.log("âŒ Input action '%s' does not exist" % action_name)
        return false
    
    InputMap.action_erase_event(action_name, event)
    ArgodeSystem.log("ğŸ—‘ï¸ Removed event from action '%s'" % action_name)
    return true

## å…¥åŠ›ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ã™ã¹ã¦ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚¯ãƒªã‚¢
func clear_action_events(action_name: String) -> bool:
    if not InputMap.has_action(action_name):
        ArgodeSystem.log("âŒ Input action '%s' does not exist" % action_name)
        return false
    
    var events = InputMap.action_get_events(action_name)
    for event in events:
        InputMap.action_erase_event(action_name, event)
    
    ArgodeSystem.log("ğŸ§¹ Cleared all events from action '%s'" % action_name)
    return true

## å…¥åŠ›ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒƒãƒ‰ã‚¾ãƒ¼ãƒ³ã‚’è¨­å®š
func set_action_deadzone(action_name: String, deadzone: float) -> bool:
    if not InputMap.has_action(action_name):
        ArgodeSystem.log("âŒ Input action '%s' does not exist" % action_name)
        return false
    
    InputMap.action_set_deadzone(action_name, deadzone)
    ArgodeSystem.log("ğŸ¯ Set deadzone for action '%s' to %.2f" % [action_name, deadzone])
    return true

## === ä¾¿åˆ©ãªé«˜ãƒ¬ãƒ™ãƒ«é–¢æ•° ===

## ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒ‰ã‚»ãƒƒãƒˆã‚’ä¸€æ‹¬ã§è¿½åŠ 
func add_key_binding_set(bindings: Dictionary) -> bool:
    var success = true
    for action_name in bindings:
        var binding_data = bindings[action_name]
        
        # ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆï¼‰
        if not InputMap.has_action(action_name):
            var deadzone = binding_data.get("deadzone", 0.5)
            add_input_action(action_name, deadzone)
        
        # ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒ‰ã‚’è¿½åŠ 
        if binding_data.has("keys"):
            for key in binding_data.keys:
                if not add_key_to_action(action_name, key):
                    success = false
        
        # ãƒã‚¦ã‚¹ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
        if binding_data.has("mouse_buttons"):
            for button in binding_data.mouse_buttons:
                if not add_mouse_button_to_action(action_name, button):
                    success = false
        
        # ã‚¸ãƒ§ã‚¤ãƒ‘ãƒƒãƒ‰ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
        if binding_data.has("joypad_buttons"):
            for button in binding_data.joypad_buttons:
                if not add_joypad_button_to_action(action_name, button):
                    success = false
    
    return success

## Argodeç”¨ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒ‰ã‚’è¨­å®š
## TODO: æœ¬ç•ªã§ã¯ä¿®æ­£äºˆå®šã€‚
func setup_argode_default_bindings():
    var argode_bindings = {
        "argode_advance": {
            "keys": [KEY_SPACE, KEY_ENTER],
            "mouse_buttons": [MOUSE_BUTTON_LEFT],
            "joypad_buttons": [JOY_BUTTON_A],
            "deadzone": 0.2
        },
        "argode_skip": {
            "keys": [KEY_CTRL],
            "mouse_buttons": [MOUSE_BUTTON_RIGHT],
            "joypad_buttons": [JOY_BUTTON_B],
            "deadzone": 0.2
        },
        "argode_menu": {
            "keys": [KEY_ESCAPE, KEY_M],
            "joypad_buttons": [JOY_BUTTON_START],
            "deadzone": 0.2
        },
        "argode_save": {
            "keys": [KEY_S],
            "deadzone": 0.2
        },
        "argode_load": {
            "keys": [KEY_L],
            "deadzone": 0.2
        }
    }
    
    ArgodeSystem.log("ğŸ® Setting up Argode default key bindings...")
    return add_key_binding_set(argode_bindings)

## ç¾åœ¨ã®å…¥åŠ›ãƒãƒƒãƒ—ã‚’ãƒ­ã‚°å‡ºåŠ›ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
func debug_print_input_map():
    ArgodeSystem.log("=== Current InputMap ===")
    for action in InputMap.get_actions():
        var events = InputMap.action_get_events(action)
        var deadzone = InputMap.action_get_deadzone(action)
        ArgodeSystem.log("Action: %s (deadzone: %.2f)" % [action, deadzone])
        for event in events:
            ArgodeSystem.log("  - %s" % event)
    ArgodeSystem.log("========================")

## === ä½¿ç”¨ä¾‹ã¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ===

## ã‚·ãƒŠãƒªã‚ªé€²è¡Œç”¨ã®ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒ‰ã‚’è¨­å®š
func setup_story_mode_bindings():
    # æ—¢å­˜ã®ãƒã‚¤ãƒ³ãƒ‰ã‚’ã‚¯ãƒªã‚¢
    clear_action_events("argode_advance")
    clear_action_events("argode_skip")
    
    # ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰ç”¨ã®ãƒã‚¤ãƒ³ãƒ‰ã‚’è¨­å®š
    add_key_to_action("argode_advance", KEY_SPACE)
    add_key_to_action("argode_advance", KEY_ENTER)
    add_mouse_button_to_action("argode_advance", MOUSE_BUTTON_LEFT)
    
    add_key_to_action("argode_skip", KEY_CTRL)
    add_mouse_button_to_action("argode_skip", MOUSE_BUTTON_RIGHT)
    
    ArgodeSystem.log("ğŸ“– Story mode key bindings configured")

## ãƒŸãƒ‹ã‚²ãƒ¼ãƒ ç”¨ã®ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒ‰ã‚’è¨­å®š
## â€»ã‚µãƒ³ãƒ—ãƒ«å®Ÿè£…
func setup_minigame_bindings():
    # ãƒŸãƒ‹ã‚²ãƒ¼ãƒ ç”¨ã®ä¸€æ™‚çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
    add_input_action("minigame_up", 0.1)
    add_input_action("minigame_down", 0.1)
    add_input_action("minigame_left", 0.1)
    add_input_action("minigame_right", 0.1)
    add_input_action("minigame_action", 0.2)
    
    # WASD + Spaceãƒã‚¤ãƒ³ãƒ‰
    add_key_to_action("minigame_up", KEY_W)
    add_key_to_action("minigame_down", KEY_S)
    add_key_to_action("minigame_left", KEY_A)
    add_key_to_action("minigame_right", KEY_D)
    add_key_to_action("minigame_action", KEY_SPACE)
    
    # çŸ¢å°ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒ‰
    add_key_to_action("minigame_up", KEY_UP)
    add_key_to_action("minigame_down", KEY_DOWN)
    add_key_to_action("minigame_left", KEY_LEFT)
    add_key_to_action("minigame_right", KEY_RIGHT)
    
    # ã‚¸ãƒ§ã‚¤ãƒ‘ãƒƒãƒ‰ãƒã‚¤ãƒ³ãƒ‰
    add_joypad_button_to_action("minigame_action", JOY_BUTTON_A)
    add_joypad_axis_to_action("minigame_up", JOY_AXIS_LEFT_Y, -1.0)
    add_joypad_axis_to_action("minigame_down", JOY_AXIS_LEFT_Y, 1.0)
    add_joypad_axis_to_action("minigame_left", JOY_AXIS_LEFT_X, -1.0)
    add_joypad_axis_to_action("minigame_right", JOY_AXIS_LEFT_X, 1.0)
    
    ArgodeSystem.log("ğŸ¯ Minigame key bindings configured")

## ãƒŸãƒ‹ã‚²ãƒ¼ãƒ çµ‚äº†æ™‚ã«ãƒã‚¤ãƒ³ãƒ‰ã‚’å‰Šé™¤
func cleanup_minigame_bindings():
    remove_input_action("minigame_up")
    remove_input_action("minigame_down")
    remove_input_action("minigame_left")
    remove_input_action("minigame_right")
    remove_input_action("minigame_action")
    
    ArgodeSystem.log("ğŸ§¹ Minigame key bindings cleaned up")

## ã‚«ã‚¹ã‚¿ãƒ ã‚­ãƒ¼ã‚³ãƒ³ãƒ•ã‚£ã‚°ã‚’é©ç”¨
func apply_custom_key_config(config: Dictionary):
    for action_name in config:
        if InputMap.has_action(action_name):
            clear_action_events(action_name)
            var keys = config[action_name]
            for key in keys:
                add_key_to_action(action_name, key)
    
    ArgodeSystem.log("âš™ï¸ Custom key configuration applied")
